<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Experiment 3</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <script>
      var sampleTypes = [];
      var sample = 0;

      var ratio;
      var graphType;

      var actualResults = [];
      var userResults = [];

      function shuffle(array) {
          for(let j = array.length - 1; j > 0; j--) {
              // pick a random index
              let i = Math.floor(Math.random() * (j + 1));

              // swap i and j
              let temp = array[j];
              array[j] = array[i];
              array[i] = temp;
          }
      }

      function startup() {
          for(let j = 0; j < 20; j++) {
              sampleTypes.push(1);
              sampleTypes.push(2);
              sampleTypes.push(3);
          }

          shuffle(sampleTypes);

          createNextGraph();
      }

      function submitForm(userRatio, realRatio, type) {
        let body = encodeURIComponent("entry.1787645303") + "=" + encodeURIComponent(type) + "&" +
                   encodeURIComponent("entry.106608498")  + "=" + encodeURIComponent(realRatio) + "&" +
                   encodeURIComponent("entry.106449377")  + "=" + encodeURIComponent(userRatio);

        fetch("https://docs.google.com/forms/u/0/d/e/1FAIpQLSc-EWN7A-s-h5WLbm05p8LaElfEsVPvt59aPFgaoRRIK0X_vg/formResponse", {
          method: "POST",
          headers: {
             'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
          },
          body: body
        });
      }

      function submitSample() {
        if(sample === 59) {
          alert("Thank you for participating!");
        }

        let userRatio = parseInt(document.getElementById("userin").value);
        let realRatio = Math.round(ratio);

        submitForm(userRatio, realRatio, graphType);

        // remove and create new graph
        let svg = d3.select("#container");
        svg.selectAll("*").remove();

        document.getElementById("userin").value = "";

        createNextGraph();
      }

      function createNextGraph() {
          graphType = sampleTypes[sample];

          if(graphType === 1) {
              // bar chart
              let data = [];

              for(let j = 0; j < 10; j++) {
                  data.push(20 + Math.random() * 200);
              }
              
              // indices for the two dotted data points
              let index1 = Math.floor(10 * Math.random());
              let index2 = Math.floor(10 * Math.random());
              while(index2 === index1) index2 = Math.floor(10 * Math.random());

              // this is the correct percentage
              ratio = 100.0 * Math.min(data[index1], data[index2]) / Math.max(data[index1], data[index2]);
          
              // start generating the graph
              let margin = {top: 30, right: 30, bottom: 30, left: 30};
              let width = 600 - margin.left - margin.right;
              let height = 600 - margin.top - margin.bottom;

              let svg = d3.select("#container")
                  .append("svg")
                      .attr("width", 600)
                      .attr("height", 600)
                  .append("g")
                      .attr("transform",
                          "translate(" + margin.left + "," + margin.top + ")");
          
              // x axis
              let x = d3.scaleBand()
                  .range([0, width])
                  .domain(data)
                  .padding(0.2);
              svg.append("g")
                  .attr("transform", "translate(0," + height + ")")
                  .call(d3.axisBottom(x).tickFormat(""));

              // y axis
              let y = d3.scaleLinear()
                  .domain([0, 220])
                  .range([height, 0]);
              svg.append("g")
                  .call(d3.axisLeft(y).tickFormat(""));

              svg.selectAll("mybar")
                  .data(data)
                  .enter()
                  .append("rect")
                      .attr("x", d => x(d))
                      .attr("y", d => y(d))
                      .attr("width", x.bandwidth())
                      .attr("height", d => height - y(d))
                      .attr("fill", "#69b3a2");

              svg.selectAll("dot")
                  .data(
                      [{Index: index1, Value: data[index1]},
                       {Index: index2, Value: data[index2]}]
                  )
                  .enter()
                  .append("circle")
                      .attr("r", 5)
                      .attr("cx", d => (x(d.Value) + 21))
                      .attr("cy", d => y(d.Value / 2))
                      .attr("fill", "black");
          } else if(graphType === 2) {
              // pie chart
              let data = [];

              for(let j = 0; j < 10; j++) {
                  data.push(20 + Math.random() * 200);
              }
              
              // indices for the two dotted data points
              let index1 = Math.floor(10 * Math.random());
              let index2 = Math.floor(10 * Math.random());
              while(index2 === index1) index2 = Math.floor(10 * Math.random());

              // this is the correct percentage
              ratio = 100.0 * Math.min(data[index1], data[index2]) / Math.max(data[index1], data[index2]);
          
              // start generating the graph
              let margin = {top: 30, right: 30, bottom: 30, left: 30};
              let width = 600 - margin.left - margin.right;
              let height = 600 - margin.top - margin.bottom;

              let radius = Math.min(width, height) / 2 - margin.top;
              
              let svg = d3.select("#container")
                  .append("svg")
                      .attr("width", 600)
                      .attr("height", 600)
                  .append("g")
                      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
          
              let pie = d3.pie()
                  .value(d => d).sort(null);
              let prepData = pie(data);

              let arcGen = d3.arc()
                              .innerRadius(0)
                              .outerRadius(radius);

              svg.selectAll("mypie")
                  .data(prepData)
                  .enter()
                  .append("path")
                      .attr("d", arcGen)
                      .attr("fill", "#69b3a2")
                      .attr("stroke", "black")
                      .style("stroke-width", "2px");

              svg.selectAll("dot")
                  .data(prepData)
                  .enter()
                  .append("circle")
                      .attr("transform", d => {
                          return "translate(" + arcGen.centroid(d) + ")";
                      })
                      .attr("r", 5)
                      .attr("fill", "black")
                      .style("opacity", (d, i) => {
                          return (i === index1 || i === index2) ? 1 : 0;
                      });
          } else {
              // circular bar plot
              let data = [];

              for(let j = 0; j < 10; j++) {
                  data.push(20 + Math.random() * 200);
              }
              
              // indices for the two dotted data points
              let index1 = Math.floor(10 * Math.random());
              let index2 = Math.floor(10 * Math.random());
              while(index2 === index1) index2 = Math.floor(10 * Math.random());

              // this is the correct percentage
              ratio = 100.0 * Math.min(data[index1], data[index2]) / Math.max(data[index1], data[index2]);
          
              // start generating the graph
              let margin = {top: 30, right: 30, bottom: 30, left: 30};
              let width = 600 - margin.left - margin.right;
              let height = 600 - margin.top - margin.bottom;

              let innerRadius = 50;
              let outerRadius = Math.min(width, height) / 2 - margin.top;

              let svg = d3.select("#container")
                  .append("svg")
                      .attr("width", 600)
                      .attr("height", 600)
                  .append("g")
                      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

              let x = d3.scaleBand()
                  .range([0, 2 * Math.PI])
                  .domain(data);

              let y = d3.scaleRadial()
                  .range([innerRadius, outerRadius])
                  .domain([0, 220]);

              svg.append("g")
                  .selectAll("path")
                  .data(data)
                  .enter()
                  .append("path")
                      .attr("fill", "#69b3a2")
                      .attr("stroke", "black")
                      .style("stroke-width", "2px")
                      .attr("d", d3.arc()
                          .innerRadius(innerRadius)
                          .outerRadius(d => y(d))
                          .startAngle(d => x(d))
                          .endAngle(d => x(d) + x.bandwidth())
                          .padAngle(0.2)
                          .padRadius(innerRadius));

              svg.selectAll("dot")
                  .data(data)
                  .enter()
                  .append("circle")
                      .attr("transform", d => {
                          return "rotate(" + ((x(d) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")translate(" + (y(d / 2)) + ",0)";
                      })
                      .attr("r", 5)
                      .attr("fill", "black")
                      .style("opacity", (d, i) => {
                          return (i === index1 || i === index2) ? 1 : 0;
                      });
          }

          sample++;
          document.getElementById("counter").innerHTML = "Sample " + sample + "/60";
      }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;1,100;1,200;1,300;1,400;1,500&display=swap"
      rel="stylesheet"
    />
    <style>
      html * {
        font-family: "Raleway", sans-serif !important ;
        color: #2a2b2a;
        background-color: #fffafa;
      }
      input[type="text"] {
        width: 100%;
        padding: 12px 20px;
        margin: 8px 0;
        box-sizing: border-box;
        border: 3px solid #ccc;
        -webkit-transition: 0.5s;
        transition: 0.5s;
        outline: none;
      }

      button1 {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
      }

      input[type="text"]:focus {
        border: 3px solid #555;
      }
    </style>
  </head>
  <body onload="startup();">
    <h1 align="center">Let's get started!</h1>

    <h3 align="center">
      In this experiment, you are asked to judge what is the percent of smaller
      value to a larger value in several charts. For each chart shown, please enter a
      number between 1 and 100 that represents the percentage of value that the smaller
      dotted data point is of the larger. 
    </h3>

    <p id="counter">Sample 1/60</p>

    <div id="container"></div> 

<div align="center" id="container"></div>

<div align="center">
  <form onsubmit="submitSample(); return false;">
    <label for="userin">Type Your Guess Below, then click enter to continue:</label>
    <input type="text" id="userin" name="userin" />
      <input type="submit" value="Submit">
    </button1>
  </form>
  <script>
    function myFunction() {
      document.getElementById("userin").submit();
      console.log(document.getElementById("userin"))
    }
    </script>
  </div>
  </body>
</html>
