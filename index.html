<!DOCTYPE html>
<html>
<head>
	<title> a3 </title>
	<script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
	<header id="header">
		<h2> Welcome! Please enter a user ID to continue: </h2>
	</header>
	<div id ="vis">
		<svg width="300" height="300" radius="140"> </svg>
	<script type="text/javascript">
		let svg = d3.select("svg");
		let colorSet = ["#FF0000","#0000FF","#f2f2f2","#e2e2e2","#cecece",
				        "#b4b4b4","#979797","#7a7a7a","#5f5f5f","#404040"];
		let data = [];
		let trial_num = 0;
		let vis_type = "";
		let trials = {};
		const trials_per_chart_type = 20;
		let completed_trials = [0,0,0];
		let participant_id = false;
		function make_data()
		{
			let count = Math.floor(6 * Math.random() + 5);
			data = [count];
			for(i = 0 ; i < count ; i++) { data[i] = 15 + Math.floor(Math.random() * 85); }
			return data;
		}
		function remove_chart()
		{
			svg.selectAll("*").remove();
		}
		function create_pie_chart(data)
		{
			vis_type = "Pie";
			var svg = d3.select("svg");
			let g = svg.append("g").attr("transform","translate(150,150)");
			var pie = d3.pie();
			var arc = d3.arc().innerRadius(0).outerRadius(140);
			var arcs = g.selectAll("arc").data(pie(data)).enter().append("g");
			arcs.append("path").attr("fill", function(data, i) {
				let value = data.data;
				return colorSet[i]; })
				.style("stroke", "black")
				.style("stroke-width", 2)
				.attr("d", arc);
		}
		function create_bar_chart(data)
		{
			vis_type = "Bar";
			let y_scale = d3.scaleLinear().domain([0, 100]).range([220, 0]).nice();
			const point = svg.selectAll("rect").data(data).join("rect")
				.style("stroke", "black")
				.attr("fill", function(d, i) { return colorSet[i]; })
				.attr("x", function(d, i) { return 40 + 20 * i + 5 * (i + 1); })
				.attr("y", function(d) { return 40 + y_scale(100 - d); })
				.attr("width", 20)
				.attr("height", function(d) { return y_scale(d); });
			var y_axis = d3.axisLeft(y_scale).ticks(1).tickFormat(d => "");
			svg.append("g").attr("transform", "translate(40,40)").call(y_axis);
		}
        	function create_line_plot(data)
        	{
            		vis_type = "Line";
			var svg = d3.select("svg"), width = svg.attr("width")-40, height = svg.attr("height")-40;
			var y = d3.scaleLinear().domain([0, 100]).range([220, 0]).nice();
			svg.append("g")
				.attr("transform", "translate(40,40)")
				.call(d3.axisLeft(y).ticks(5).tickFormat(d => ""));
			var x = d3.scaleLinear()
				.domain(d3.extent(data, function(d,i) { return i; }))
				.range([ 0, width ]);
			//line
			svg.append("path")
				.datum(data)
				.attr("fill", "none")
				.attr("stroke", "black")
				.attr("stroke-width", 2)
				.attr("d", d3.line()
					.x(function(d, i) { return 40 + 20 * i + 5 * (i + 1); })
					.y(function(d) { return 40+y(100-d) }));
			//dot
			svg.selectAll("myCircles")
				.data(data)
				.enter()
				.append("circle")
					.attr("fill", function(d, i) { return colorSet[i]; })
					.attr("stroke", "none")
					.attr("cx", function(d,i) { return 40 + 20 * i + 5 * (i + 1); })
					.attr("cy", function(d) { return 40+y(100-d) })
					.attr("r", 5);
        	}
		function calculate_ans()
		{
			let val1 = data[0];
			let val2 = data[1];
			let answer = 100;
			if( val1 > val2 ) { answer = Math.floor( 100 * val2 / val1 ); }
			if( val2 > val1 ) { answer = Math.floor( 100 * val1 / val2 ); }
			return answer;
		}
		function submit_vals(input)
		{
			// TODO: replace these 7 lines:
				trials[trial_num] = {};
				trials[trial_num]["ParticipantID"] = participant_id;
				trials[trial_num]["TrialNum"] = (trial_num + 1);
				trials[trial_num]["Vis"] = vis_type;
				trials[trial_num]["TruePercent"] = calculate_ans();
				trials[trial_num]["ReportedPercent"] = input;
				console.log(trials[trial_num]);
			// with a sendData call
			trial_num++;
		}
		function show_complete_message(input)
		{
			document.getElementById("header").innerHTML = "<h2> You finished! Congratulations! </h2>";
			document.getElementById("form").remove();
			for( i = 0 ; i <= trial_num ; i++ )
			{
				let trialN = trials[i][TrialNum];
				let chartType = trials[i][Vis];
				let actualPercent = trials[i][TruePercent];
				let enteredPercent = trials[i][ReportedPercent];
				sendData(participant_id, trialN, chartType, actualPercent, enteredPercent);
			}
		}
		function new_chart()
		{
			let input = document.getElementById("input");
			if(data.length > 0 && input.value.length > 0)
			{
				submit_vals(input.value);
				document.getElementById("input").value = '';
			}
			remove_chart();
			data = make_data();
			
			let unfinished_types = 3;
			for (let i = 0; i < 3; ++i)
			{
				if (completed_trials[i] >= trials_per_chart_type)
				{
					--unfinished_types;
				}
			}
			if (unfinished_types == 0)
			{
				show_complete_message();
			}
			else
			{
				let decider = Math.floor(Math.random() * unfinished_types);
				if (decider == 0)
				{
					if (completed_trials[0] < trials_per_chart_type)
					{
						create_pie_chart(data);
						++completed_trials[0];
					}
					else if (completed_trials[1] < trials_per_chart_type)
					{
						create_bar_chart(data);
						++completed_trials[1];
					}
					else if (completed_trials[2] < trials_per_chart_type)
					{
						create_line_plot(data);
						++completed_trials[2];
					}
					else
					{ console.log("Tried to create a plot of the first unfinished type, but all three types are finished."); }
				}
				else if (decider == 1)
				{
					if (completed_trials[0] < trials_per_chart_type)
					{
						create_bar_chart(data);
						++completed_trials[1];
					}
					else if (completed_trials[1] < trials_per_chart_type)
					{
						create_line_plot(data);
						++completed_trials[2];
					}
					else
					{ console.log("Tried to create a plot of the second unfinished type, but there is no more than one unfinished type."); }
				}
				else if (decider == 2)
				{
					if (completed_trials[0] < trials_per_chart_type)
					{
						create_line_plot(data);
						++completed_trials[2];
					}
					else
					{ console.log("Tried to create a plot of the third unfinished type, but there are no more than two unfinished types."); }
				}
				else { console.log("Invalid plot type"); }
			}
		}
		function onButtonPress()
		{
			if (participant_id === false)
			{
				// Get participant ID
				let input = document.getElementById("input");
				if(input.value.length > 0)
				{
					participant_id = input.value;
					document.getElementById("input").value = '';
					
					new_chart();
					
					// Set up document
					document.getElementById("header").innerHTML = '<h2> Two values in the graph have color. </h2>		<h2> What do you think the percent of the smaller value to the larger value is? </h2>		<h3> e.g. If you think the smaller one is exactly 1/2 of the bigger one, input "50" </h3>';
				}
				// If the user didn't enter a participant ID yet, don't generate a chart yet
			}
			else
			{
				new_chart();
			}
		}
		function sendData(participantID, trialN, chartType, actualPercent, enteredPercent) {
			json = { participantID: participantID, trialN: trialN, chartType: chartType, actualPercent: actualPercent, enteredPercent: enteredPercent},
			body = JSON.stringify(json);
			fetch('/newData', {
	  			method: 'POST',
	   			headers: {
					 'Accept': 'application/json, text/plain, */*',
					 'Content-Type': 'application/json'
				},
		   		body: body
	 		})
	 		.then(res => res) // parse the JSON from the server
			.then(data => {
	   		});
		}
	</script>
	<br><br>
	<form name="input" id="form" action="javascript:void(null)">
		<label for="input">Input:</label>
		<input type="text" id="input" name="input">
		<input type="submit" value="Submit" onclick="onButtonPress()"/><br/>
	</form>
	<h1 id="completemessage"> </h1>
	</div>
</body>
</html>
